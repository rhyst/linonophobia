<html>

<head>
<script src='helper.js'></script>
<script src='config.js'></script>
</head>

<body>
    <canvas id="canvas" width="400" height="400" style="border:1px solid #000000;">
    </canvas>
    <div id="data">
        <div><button id="start">Start</button><button id="stop">Stop</button></div>
        <div>From: <input id="from"></input></div>
        <div>To: <input id="to"></input></div>
        <div>Force: <span id="result"></span></div>
    </div>
    <script>
        var c = document.getElementById("canvas");
        var ctx = c.getContext("2d");
        var nodes = [];

        var worker = new Worker('worker.js');
        worker.onmessage = function(data) {
            //console.log(data.data)
            nodes = data.data;
            draw();
            compute();
        };
        worker.postMessage('init');

        document.getElementById('start').addEventListener('click', function() {
            worker.postMessage('run')
        })

        document.getElementById('stop').addEventListener('click', function() {
            worker.postMessage('pause')
        })

        function draw() {
            ctx.clearRect(0, 0, c.width, c.height);
            ctx.beginPath();
            ctx.moveTo(10, 50);
            ctx.lineTo(10, 50 + (10 * metre));
            ctx.fillText("10m", 11, 50 + (10 * metre / 2))
            drawn = [];
            function drawLine(node, connectedNodeID) {
                ctx.fillRect(node.position.x - 1, node.position.y - 1, 3, 3);
                ctx.fillText(node.id, node.position.x + 1, node.position.y)
                if (drawn.indexOf(connectedNodeID.toString() + node.id.toString()) < 0) {
                    var connectedNode = getNode(connectedNodeID, nodes);
                    //var midpoint = getMidpoint(node, connectedNode);
                    //ctx.fillText("x: " + node.force.x.toFixed(3) + " y: " + node.force.y.toFixed(3) ,midpoint.x,midpoint.y);
                    ctx.moveTo(connectedNode.position.x, connectedNode.position.y);
                    ctx.lineTo(node.position.x, node.position.y);
                    drawn.push(node.id.toString() + connectedNode.id.toString())
                }
            }
            nodes.forEach(function (node) {
                node.connectedNodes.forEach(drawLine.bind(this, node));
            })
            ctx.stroke();
        }
        function compute() {
            var connected = false;
            function computeNode(node, connectedNodeID) {
                if (parseInt(document.getElementById("to").value) === connectedNodeID) {
                    connected = true;
                    var connectedNode = getNode(connectedNodeID, nodes);
                    var stringLength = getLength(connectedNode, node);
                    var lengthDifference = stringLength - nominalStringLength;
                    var angleFromHorizontal = getAngleFromHorizontal(node, connectedNode);
                    var ySpringForce = Math.sin(angleFromHorizontal) * lengthDifference * springConstant;
                    var xSpringForce = Math.cos(angleFromHorizontal) * lengthDifference * springConstant;
                    document.getElementById('result').innerText = Math.sqrt((ySpringForce*ySpringForce)+(xSpringForce+xSpringForce)).toFixed(3) + "N";
                }                
            };
            nodes.forEach(function (node) {
                if (parseInt(document.getElementById("from").value) === node.id) {
                    node.connectedNodes.forEach(computeNode.bind(this, node));
                };
            })
            if (!connected) {
                document.getElementById('result').innerText = "Not connected"
            }
        }

        function frameSyncer(timestamp) {
            worker.postMessage('send');
            requestAnimationFrame(frameSyncer)
        }
        requestAnimationFrame(frameSyncer)

        worker.postMessage('run')
    </script>
</body>

</html>

<!--
dy/dt = yGravForce + ySpringForce



-->